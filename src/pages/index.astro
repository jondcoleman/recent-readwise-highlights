---
import Layout from "../layouts/Layout.astro";
import HighlightList from "../components/HighlightList.tsx";
import type { HighlightCardProps } from "../components/HighlightCard.tsx";
import TokenInput from "../components/TokenInput.tsx";
import { getHighlights } from "../utils/getHighlights.ts";

let token;
let highlights;
let highlightsProps: HighlightCardProps[];

if (Astro.cookies.has("token")) {
  const tokenCookie = Astro.cookies.get("token");
  token = tokenCookie.value;
  highlights = await getHighlights(token);

  if (highlights) {
    // create the props object to pass to the HighlightList component
    highlightsProps = highlights.map((highlight) => ({
      quote: highlight.text,
      author: highlight.book.author,
      sourceId: highlight.book.id.toString(),
      sourceName: highlight.book.title,
    }));
  }
}

export const prerender = false;
---

<Layout title="Recent Readwise Highlights">
  <main class="mx-auto prose">
    <h2 class="text-center" mx-auto>Recent Highlights</h2>
    {
      highlights ? (
        <HighlightList highlights={highlightsProps} />
      ) : (
        <>
          <p>Enter a valid token to see highlights.</p>
          <TokenInput client:load />
        </>
      )
    }
  </main>
</Layout>
